<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <title>Tyres UI — остатки и предложения</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root{--bg:#0f172a;--fg:#e5e7eb;--muted:#94a3b8;--card:#111827;--ink:#0b1220;--line:#334155;--acc:#22d3ee}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--fg);font:14px/1.45 system-ui,Segoe UI,Roboto,Arial}
    .wrap{max-width:1200px;margin:24px auto;padding:0 16px}
    h1{margin:0 0 12px;font-size:22px}
    .card{background:var(--card);border-radius:14px;padding:16px;box-shadow:0 4px 24px rgba(0,0,0,.25);margin-bottom:16px}
    .grid{display:grid;gap:12px}
    @media(min-width:1100px){ .cols-3{grid-template-columns:1fr 1fr 1fr} }
    label{display:block;margin:0 0 6px;color:var(--muted)}
    input,select{width:100%;padding:8px 10px;border-radius:10px;border:1px solid var(--line);background:var(--ink);color:var(--fg)}
    select[multiple]{min-height:164px}
    .inline{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .btn{padding:9px 14px;border-radius:10px;border:1px solid var(--line);background:var(--ink);color:var(--fg);cursor:pointer}
    .btn.primary{background:linear-gradient(90deg,#06b6d4,#22d3ee);color:#0b1220;border:none}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .muted{color:var(--muted)}
    .warn{color:#fca5a5}
    .pill{display:inline-flex;gap:6px;align-items:center;background:#0b1322;border:1px solid #223049;border-radius:999px;padding:4px 8px;font-size:12px}
    table{width:100%;border-collapse:collapse}
    th,td{padding:8px 10px;border-bottom:1px solid #1f2937;vertical-align:top}
    th{color:var(--muted);text-align:left}
    .img{width:80px;height:80px;background:#0b1220;border:1px solid #263244;border-radius:10px;object-fit:contain}
    .row{display:grid;grid-template-columns:92px 1fr 1.2fr;gap:12px}
    .kvs{display:grid;grid-template-columns:120px 1fr;gap:4px 10px;font-size:12px;color:#cbd5e1}
    .kvs b{color:#94a3b8;font-weight:500}
    .bar{display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap}
    .pagination{display:flex;gap:6px;flex-wrap:wrap}
    .pg{min-width:32px;padding:6px 10px;border:1px solid var(--line);border-radius:10px;background:var(--ink);cursor:pointer}
    .pg.active{background:linear-gradient(90deg,#06b6d4,#22d3ee);color:#0b1220;border:none}
    .filtersBox{display:grid;gap:10px}
    .filtersBox .inline>*{flex:1}
    .pair{display:grid;grid-template-columns:1fr 1fr;gap:8px}
    .hint{font-size:12px;color:var(--muted);margin-top:6px}
    .searchline{display:flex;gap:8px}
  </style>
</head>
<body>
<div class="wrap">
  <h1>Легковые шины — остатки и предложения</h1>

  <div class="card">
    <div class="grid cols-3">
      <!-- Тех. характеристики -->
      <section>
        <label class="pill">Технические характеристики</label>
        <div class="filtersBox">
          <div class="pair">
            <div><label>Ширина</label><select id="width"></select></div>
            <div><label>Высота</label><select id="height"></select></div>
          </div>
          <div class="pair">
            <div><label>Диаметр</label><select id="diameter"></select></div>
            <div><label>Страна</label><select id="country"></select></div>
          </div>
          <div><label>Бренд</label><select id="brand"></select></div>
          <div><label>Модель</label><input id="model" type="text" placeholder="введите часть названия" /></div>
          <div class="pair">
            <div><label>Сезон</label><select id="season"><option value="">—</option><option>летняя</option><option>зимняя</option><option>всесезон</option></select></div>
            <div><label>Шипы</label><select id="spikes"><option value="">—</option><option value="yes">есть</option><option value="no">нет</option></select></div>
          </div>
          <div class="pair">
            <div><label>RunFlat</label><select id="runflat"><option value="">—</option><option value="yes">да</option><option value="no">нет</option></select></div>
            <div><label>Cargo</label><select id="cargo"><option value="">—</option><option value="yes">да</option><option value="no">нет</option></select></div>
          </div>
          <div class="inline">
            <label class="pill"><input type="checkbox" id="mt"> MT</label>
            <label class="pill"><input type="checkbox" id="at"> AT</label>
            <label class="pill"><input type="checkbox" id="xl"> XL</label>
          </div>
        </div>
      </section>

      <!-- Параметры поставщика -->
      <section>
        <label class="pill">Параметры поставщика</label>
        <div class="filtersBox">
          <div class="pair">
            <div><label>Цена от (руб.)</label><input id="priceFrom" type="number" min="0" step="1" placeholder="—" /></div>
            <div><label>Цена до (руб.)</label><input id="priceTo" type="number" min="0" step="1" placeholder="—" /></div>
          </div>
          <div class="pair">
            <div><label>Мин. остаток на складе</label><input id="minPerWh" type="number" min="0" step="1" value="1" /></div>
            <div><label>Мин. общий остаток</label><input id="minTotal" type="number" min="0" step="1" value="1" /></div>
          </div>

          <div>
            <label>Город склада(ов)</label>
            <div class="searchline"><input id="cityQ" type="text" placeholder="поиск по городу…"/><button class="btn" id="cityClr">×</button></div>
            <select id="cities" multiple></select>
            <div class="hint" id="cityCount">—</div>
          </div>

          <div>
            <label>Поставщик(и)</label>
            <div class="searchline"><input id="supQ" type="text" placeholder="поиск по поставщику…"/><button class="btn" id="supClr">×</button></div>
            <select id="suppliers" multiple></select>
            <div class="hint" id="supCount">—</div>
          </div>

          <div><label>Артикул поставщика</label><input id="vendorSku" type="text" placeholder="часть кода" /></div>
          <label class="pill"><input type="checkbox" id="availableOnly"> В наличии</label>
        </div>
      </section>

      <!-- Поиск / сортировка / экспорт -->
      <section>
        <label class="pill">Поиск и сортировка</label>
        <div class="filtersBox">
          <div><label>Код сервиса</label><input id="serviceCode" type="text" /></div>
          <div><label>Поиск по названию</label><input id="q" type="text" placeholder="offer_id / бренд / модель / размер" /></div>
          <div><label>Сортировка</label>
            <select id="sort">
              <option value="price_asc">Возрастание цены</option>
              <option value="price_desc">Убывание цены</option>
              <option value="updated_desc">Сначала обновлённые</option>
              <option value="qty_desc">По убыванию остатка</option>
            </select>
          </div>
          <div class="inline">
            <button class="btn primary" id="btnApply">Подобрать</button>
            <button class="btn" id="btnReset">Сбросить</button>
            <button class="btn" id="btnCSV" disabled>Скачать CSV</button>
          </div>
          <div class="hint" id="hint">Загружаем данные…</div>
        </div>
      </section>
    </div>
  </div>

  <div class="card">
    <div class="bar">
      <div>Найдено моделей: <b id="found">0</b> • Показано: <b id="shown">0</b></div>
      <div class="inline"><label class="muted">На странице</label><select id="pageSize"><option>10</option><option selected>20</option><option>50</option></select></div>
    </div>
    <div id="results"></div>
    <div class="bar" style="margin-top:10px">
      <div class="pagination" id="pager"></div>
      <div class="muted" id="stats">—</div>
    </div>
  </div>

  <div class="muted">Источник данных: <code>docs/data/master.json</code> (обновляется Actions). Для отладки есть <a href="./debug.html">debug.html</a>.</div>
</div>

<script>
const DATA_URL = 'data/master.json'; // относительно docs/

const $ = id => document.getElementById(id);
const els = {
  width: $('width'), height: $('height'), diameter: $('diameter'),
  brand: $('brand'), model: $('model'), country: $('country'),
  season: $('season'), spikes: $('spikes'), runflat: $('runflat'), cargo: $('cargo'),
  mt: $('mt'), at: $('at'), xl: $('xl'),
  priceFrom: $('priceFrom'), priceTo: $('priceTo'), minPerWh: $('minPerWh'), minTotal: $('minTotal'),
  cities: $('cities'), cityQ: $('cityQ'), cityClr: $('cityClr'), cityCount: $('cityCount'),
  suppliers: $('suppliers'), supQ: $('supQ'), supClr: $('supClr'), supCount: $('supCount'),
  vendorSku: $('vendorSku'), availableOnly: $('availableOnly'),
  serviceCode: $('serviceCode'), q: $('q'), sort: $('sort'),
  btnApply: $('btnApply'), btnReset: $('btnReset'), btnCSV: $('btnCSV'), hint: $('hint'),
  found: $('found'), shown: $('shown'), results: $('results'), pager: $('pager'),
  pageSize: $('pageSize'), stats: $('stats')
};
const S = v => (v==null ? '' : String(v).trim());
const N = v => { const n = Number(v); return Number.isFinite(n) ? n : 0; };
const get = (o,...keys) => { for (const k of keys){ if (o && typeof o==='object' && o[k]!=null && S(o[k])!=='') return o[k]; } return ''; };
const getNum = (o,...keys)=>N(get(o,...keys));
const uniq = arr => [...new Set(arr)];
const byText = (a,b)=>String(a).localeCompare(String(b),'ru',{numeric:true,ignorePunctuation:true});

function parseSizeAny(rec){
  let w=get(rec,'width','section_width'), h=get(rec,'height','aspect_ratio'), d=get(rec,'diameter','rim_diameter');
  if(!w||!h||!d){
    const sizeStr = S(get(rec,'size','dimension','attrs','title'));
    const m = sizeStr.match(/(\d{3})\s*\/\s*(\d{2})[^0-9]*R?\s*([0-9]{2})/i);
    if(m){ w=w||m[1]; h=h||m[2]; d=d||m[3]; }
  }
  return {w:S(w),h:S(h),d:S(d)};
}
function findBigArray(obj, depth=0, best={len:0, arr:null}, path='root'){
  if(depth>4||!obj) return best;
  if(Array.isArray(obj)&&obj.length>0&&typeof obj[0]==='object'){ if(obj.length>best.len) best={len:obj.length,arr:obj}; }
  else if(typeof obj==='object'){ for(const v of Object.values(obj)){ best = findBigArray(v, depth+1, best); } }
  return best;
}
function fillSelect(sel, values){
  const old = new Set([...sel.selectedOptions].map(o=>o.value));
  sel.innerHTML='';
  const empty=document.createElement('option'); empty.value=''; empty.textContent='—'; sel.appendChild(empty);
  for(const v of values){ const op=document.createElement('option'); op.value=v; op.textContent=v; if(old.has(v)) op.selected=true; sel.appendChild(op); }
}
function fillMulti(sel, arr){ const prev = new Set([...sel.selectedOptions].map(o=>o.value)); sel.innerHTML=''; for(const v of arr){ const o=document.createElement('option'); o.value=v; o.textContent=v; if(prev.has(v)) o.selected=true; sel.appendChild(o); } }

let ITEMS=[], FILTERED=[], LAST_ROWS=[];
let SUP_TO_CITIES=new Map(), CITY_TO_SUPS=new Map();
let sets={width:[],height:[],diameter:[],brands:[],countries:[],cities:[],suppliers:[]};

async function loadData(){
  try{
    els.hint.textContent='Загружаем master.json…';
    const r=await fetch(DATA_URL+'?t='+Date.now(),{cache:'no-store'}); if(!r.ok) throw new Error('HTTP '+r.status);
    const data=await r.json();

    let items=Array.isArray(data)?data:null;
    if(!items){ for(const k of ['items','data','result','products']) if(Array.isArray(data?.[k])){ items=data[k]; break; } }
    if(!items||items.length===0){ items=findBigArray(data).arr||[]; }

    ITEMS = items.map(it=>{
      const {w,h,d}=parseSizeAny(it);
      const brand=S(get(it,'brand')), model=S(get(it,'model','pattern','name'));
      const country=S(get(it,'country','made_in')), season=S(get(it,'season'));
      const spikes=S(get(it,'spikes','studded')), runflat=S(get(it,'runflat','run_flat','runFlat')), cargo=S(get(it,'cargo','lt'));
      const mt=!!get(it,'mt'), at=!!get(it,'at'), xl=!!get(it,'xl','extra_load','reinforced');
      const id=S(get(it,'offer_id','article','id','sku','code','unique_id')), img=S(get(it,'image','img','picture','image_url','img_url'));
      let suppliers=Array.isArray(it.suppliers)?it.suppliers:(S(get(it,'supplier_name','supplier','vendor','provider'))?[it]:[]);
      suppliers=suppliers.map(s=>({
        supplier:S(get(s,'supplier_name','supplier','vendor','provider')),
        city:S(get(s,'warehouse_city','city','warehouseCity')),
        warehouse:S(get(s,'warehouse_name','warehouse')),
        qty:getNum(s,'qty','quantity','stock','rest'),
        price:getNum(s,'price','cost','opt_price','wholesale'),
        retail:getNum(s,'retail','rrp','msrp','price_rrp'),
        rrc:getNum(s,'rrc','recommended','rrp_price'),
        mic:getNum(s,'mic','min_inet','map'),
        year:S(get(s,'year','prod_year')),
        updated:S(get(s,'updated','updated_at','ts','timestamp')),
        vendor_code:S(get(s,'vendor_code','vendorSku','supplier_code','supplier_sku','sku')),
        service_code:S(get(s,'service_code','svc','service')),
        delivery:S(get(s,'delivery','availability','in_stock')) || (getNum(s,'qty','quantity','stock','rest')>0?'В наличии':'—')
      }));
      return {id,brand,model,w,h,d,country,season,spikes,runflat,cargo,mt,at,xl,img,suppliers,raw:it};
    });

    const widths=[],heights=[],diams=[],brands=[],countries=[],cities=[],sups=[];
    SUP_TO_CITIES.clear(); CITY_TO_SUPS.clear();
    for(const it of ITEMS){
      if(it.w) widths.push(it.w); if(it.h) heights.push(it.h); if(it.d) diams.push(it.d);
      if(it.brand) brands.push(it.brand); if(it.country) countries.push(it.country);
      for(const s of it.suppliers){
        if(s.city) cities.push(s.city); if(s.supplier) sups.push(s.supplier);
        if(s.supplier){ if(!SUP_TO_CITIES.has(s.supplier)) SUP_TO_CITIES.set(s.supplier,new Set()); if(s.city) SUP_TO_CITIES.get(s.supplier).add(s.city); }
        if(s.city){ if(!CITY_TO_SUPS.has(s.city)) CITY_TO_SUPS.set(s.city,new Set()); if(s.supplier) CITY_TO_SUPS.get(s.city).add(s.supplier); }
      }
    }
    sets.width=uniq(widths).sort((a,b)=>Number(a)-Number(b));
    sets.height=uniq(heights).sort((a,b)=>Number(a)-Number(b));
    sets.diameter=uniq(diams).sort((a,b)=>Number(a)-Number(b));
    sets.brands=uniq(brands).sort(byText);
    sets.countries=uniq(countries).sort(byText);
    sets.cities=uniq(cities).sort(byText);
    sets.suppliers=uniq(sups).sort(byText);

    fillSelect(els.width,sets.width); fillSelect(els.height,sets.height); fillSelect(els.diameter,sets.diameter);
    fillSelect(els.brand,['—',...sets.brands]); fillSelect(els.country,['—',...sets.countries]);
    refreshSupCityLists();

    els.hint.textContent=`Загружено записей: ${ITEMS.length}`;
    applyFilters(true);
  }catch(e){ els.hint.innerHTML=`<span class="warn">Ошибка загрузки: ${e.message}</span>`; }
}

function refreshSupCityLists(){
  const qCity=S(els.cityQ.value).toLowerCase(), qSup=S(els.supQ.value).toLowerCase();
  const selCities=new Set([...els.cities.selectedOptions].map(o=>o.value));
  const selSups=new Set([...els.suppliers.selectedOptions].map(o=>o.value));

  let allowedCities;
  if(selSups.size>0){ const acc=new Set(); for(const s of selSups){ const cset=SUP_TO_CITIES.get(s); if(cset) for(const c of cset) acc.add(c);} allowedCities=[...acc]; }
  else allowedCities=[...sets.cities];
  if(qCity) allowedCities=allowedCities.filter(c=>c.toLowerCase().includes(qCity));
  allowedCities.sort(byText);

  let allowedSups;
  if(selCities.size>0){ const acc=new Set(); for(const c of selCities){ const sset=CITY_TO_SUPS.get(c); if(sset) for(const s of sset) acc.add(s);} allowedSups=[...acc]; }
  else allowedSups=[...sets.suppliers];
  if(qSup) allowedSups=allowedSups.filter(s=>s.toLowerCase().includes(qSup));
  allowedSups.sort(byText);

  fillMulti(els.cities,allowedCities); fillMulti(els.suppliers,allowedSups);
  els.cityCount.textContent=`${els.cities.options.length} городов`;
  els.supCount.textContent=`${els.suppliers.options.length} поставщиков`;
}

function applyFilters(){
  const width=S(els.width.value),height=S(els.height.value),diameter=S(els.diameter.value);
  const brand=S(els.brand.value),modelQ=S(els.model.value).toLowerCase();
  const country=S(els.country.value),season=S(els.season.value);
  const spikes=S(els.spikes.value),runflat=S(els.runflat.value),cargo=S(els.cargo.value);
  const mt=els.mt.checked,at=els.at.checked,xl=els.xl.checked;
  const priceFrom=N(els.priceFrom.value)||0,priceTo=N(els.priceTo.value)||0;
  const minPerWh=N(els.minPerWh.value)||0,minTotal=N(els.minTotal.value)||0;
  const selCities=new Set([...els.cities.selectedOptions].map(o=>o.value));
  const selSups=new Set([...els.suppliers.selectedOptions].map(o=>o.value));
  const vendorSku=S(els.vendorSku.value).toLowerCase(), availableOnly=els.availableOnly.checked;
  const serviceCode=S(els.serviceCode.value).toLowerCase(), q=S(els.q.value).toLowerCase();
  const sort=S(els.sort.value), pageSize=Number(els.pageSize.value)||20;

  const out=[];
  for(const it of ITEMS){
    if(width && it.w!==width) continue;
    if(height && it.h!==height) continue;
    if(diameter && it.d!==diameter) continue;
    if(brand && it.brand!==brand) continue;
    if(country && it.country!==country) continue;
    if(season && S(it.season).toLowerCase()!==season) continue;
    if(spikes){ const v=S(it.spikes).toLowerCase(); if((spikes==='yes' && !(v.includes('yes')||v.includes('есть'))) || (spikes==='no' && (v.includes('yes')||v.includes('есть')))) continue; }
    if(runflat){ const v=S(it.runflat).toLowerCase(); if((runflat==='yes' && !v) || (runflat==='no' && v)) continue; }
    if(cargo){ const v=S(it.cargo).toLowerCase(); if((cargo==='yes' && !v) || (cargo==='no' && v)) continue; }
    if(mt && !it.mt) continue; if(at && !it.at) continue; if(xl && !it.xl) continue;
    if(modelQ && !(`${it.model} ${it.id}`.toLowerCase().includes(modelQ))) continue;

    let totalQty=0; const offers=[];
    for(const s of it.suppliers){
      if(selCities.size>0 && !selCities.has(s.city)) continue;
      if(selSups.size>0 && !selSups.has(s.supplier)) continue;
      if(priceFrom && s.price<priceFrom) continue;
      if(priceTo && s.price>priceTo) continue;
      if(minPerWh && s.qty<minPerWh) continue;
      if(vendorSku && !S(s.vendor_code).toLowerCase().includes(vendorSku)) continue;
      if(serviceCode && !S(s.service_code).toLowerCase().includes(serviceCode)) continue;
      if(availableOnly && !(s.qty>0)) continue;
      totalQty += s.qty||0;
      offers.push(s);
    }
    if(minTotal && totalQty<minTotal) continue;
    if(offers.length===0) continue;

    if(q){ const hay = `${it.id} ${it.brand} ${it.model} ${it.w}/${it.h} R${it.d}`.toLowerCase(); if(!hay.includes(q)) continue; }

    const best = [...offers].sort((a,b)=>a.price-b.price)[0];
    const supSet = uniq(offers.map(o=>o.supplier));
    out.push({
      it, offers, totalQty,
      agg:{
        minPrice: Math.min(...offers.map(o=>o.price||Infinity)),
        maxUpdated: (offers.map(o=>Date.parse(o.updated)).filter(x=>x>0).sort((a,b)=>b-a)[0])||0,
        anyRetail: offers.find(o=>o.retail>0)?.retail||'',
        bestCity: best?.city || '',
        supList: supSet.slice(0,3).join(', ') + (supSet.length>3 ? ` +${supSet.length-3}` : '')
      }
    });
  }

  if(sort==='price_desc') out.sort((a,b)=>(b.agg.minPrice||1e15)-(a.agg.minPrice||1e15));
  else if(sort==='updated_desc') out.sort((a,b)=>b.agg.maxUpdated-a.agg.maxUpdated);
  else if(sort==='qty_desc') out.sort((a,b)=>b.totalQty-a.totalQty);
  else out.sort((a,b)=>(a.agg.minPrice||1e15)-(b.agg.minPrice||1e15));

  FILTERED=out; els.found.textContent=FILTERED.length;
  renderPage(1,pageSize);
}

function renderPage(page,pageSize){
  const total=FILTERED.length, pages=Math.max(1,Math.ceil(total/pageSize));
  if(page>pages) page=pages; const start=(page-1)*pageSize; const slice=FILTERED.slice(start,start+pageSize);
  LAST_ROWS=[];

  const html = slice.map(row=>{
    const it=row.it, a=row.agg;
    LAST_ROWS.push({offer_id:it.id,brand:it.brand,model:it.model,size:`${it.w}/${it.h} R${it.d}`,min_price:a.minPrice||'',total_qty:row.totalQty,suppliers:a.supList,best_city:a.bestCity});
    return `
    <div class="row">
      <div><img class="img" src="${esc(it.img||'')}" onerror="this.style.opacity=.15" alt=""></div>
      <div>
        <div style="font-weight:600">${esc(it.brand||'')} ${esc(it.model||'')}</div>
        <div class="kvs" style="margin-top:6px">
          <b>Код</b><div><code>${esc(it.id||'')}</code></div>
          <b>Типоразмер</b><div>${esc(`${it.w||'?'}/${it.h||'?'} R${it.d||'?'}`)}</div>
          <b>Сезон</b><div>${esc(it.season||'—')}${it.xl?' · XL':''}${it.mt?' · MT':''}${it.at?' · AT':''}${S(it.spikes).toLowerCase().includes('yes')?' · шипы':''}${it.runflat?' · RunFlat':''}${it.cargo?' · Cargo':''}</div>
          <b>Страна</b><div>${esc(it.country||'—')}</div>
        </div>
      </div>
      <div>
        <table>
          <thead><tr>
            <th>Розн. цена</th><th>Доставка</th><th>Склад</th>
            <th>Код пост.</th><th>Сервис</th><th>Кол-во</th>
            <th>Опт. цена</th><th>РРЦ</th><th>МИЦ</th><th>Год</th><th>Обновлено</th>
          </tr></thead>
          <tbody>
            ${row.offers.slice(0,6).map(o=>`
              <tr>
                <td>${o.retail?fmt(o.retail):'—'}</td>
                <td>${esc(o.delivery||'—')}</td>
                <td>${esc(o.city||'—')}${o.warehouse?(' · '+esc(o.warehouse)) : ''}</td>
                <td>${esc(o.vendor_code||'')}</td>
                <td>${esc(o.service_code||'')}</td>
                <td>${o.qty||0}</td>
                <td>${o.price?fmt(o.price):'—'}</td>
                <td>${o.rrc?fmt(o.rrc):'—'}</td>
                <td>${o.mic?fmt(o.mic):'—'}</td>
                <td>${esc(o.year||'')}</td>
                <td>${esc(o.updated||'')}</td>
              </tr>
            `).join('')}
            ${row.offers.length>6?`<tr><td colspan="11" class="muted">ещё ${row.offers.length-6} предложений скрыто</td></tr>`:''}
          </tbody>
        </table>
      </div>
    </div>
    <hr style="border:none;border-top:1px solid #1f2937;margin:12px 0">
    `;
  }).join('');

  els.results.innerHTML = html || `<div class="muted">Ничего не найдено по текущим фильтрам.</div>`;
  els.shown.textContent = slice.length;

  const totRows = FILTERED.reduce((acc,r)=>acc+r.offers.length,0);
  els.stats.textContent = `Всего строк предложений: ${totRows}`;

  els.btnCSV.disabled = LAST_ROWS.length===0;

  els.pager.innerHTML='';
  for(let i=1;i<=pages;i++){ const b=document.createElement('button'); b.className='pg'+(i===page?' active':''); b.textContent=i; b.onclick=()=>renderPage(i,pageSize); els.pager.appendChild(b); }
}

function fmt(x){ return Intl.NumberFormat('ru-RU').format(Math.round(x))+' ₽'; }
function esc(s){ return String(s||'').replace(/[&<>"]/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c])); }

function downloadCSV(){
  const header=['offer_id','brand','model','size','min_price','total_qty','suppliers','best_city'];
  const lines=[header.join(',')].concat(LAST_ROWS.map(r=>[r.offer_id,r.brand,`"${r.model.replace(/"/g,'""')}"`,r.size,r.min_price,r.total_qty,`"${r.suppliers.replace(/"/g,'""')}"`,`"${r.best_city.replace(/"/g,'""')}"`].join(',')));
  const blob=new Blob([lines.join('\n')],{type:'text/csv;charset=utf-8'}); const url=URL.createObjectURL(blob);
  const a=Object.assign(document.createElement('a'),{href:url,download:'tyres_selection.csv'}); document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
}

/* связи */
['input','change'].forEach(ev=>{
  els.cityQ.addEventListener(ev, refreshSupCityLists);
  els.supQ.addEventListener(ev, refreshSupCityLists);
  els.cities.addEventListener(ev, refreshSupCityLists);
  els.suppliers.addEventListener(ev, refreshSupCityLists);
});
els.cityClr.onclick=()=>{ els.cityQ.value=''; [...els.cities.options].forEach(o=>o.selected=false); refreshSupCityLists(); };
els.supClr.onclick=()=>{ els.supQ.value=''; [...els.suppliers.options].forEach(o=>o.selected=false); refreshSupCityLists(); };
els.btnApply.onclick=()=>applyFilters();
els.btnReset.onclick=()=>{
  for(const id of ['width','height','diameter','brand','country','season','spikes','runflat','cargo']) els[id].selectedIndex=0;
  for(const id of ['model','priceFrom','priceTo','minPerWh','minTotal','vendorSku','serviceCode','q','cityQ','supQ']) els[id].value='';
  els.minPerWh.value=1; els.minTotal.value=1; els.mt.checked=els.at.checked=els.xl.checked=els.availableOnly.checked=false;
  [...els.cities.options].forEach(o=>o.selected=false); [...els.suppliers.options].forEach(o=>o.selected=false);
  refreshSupCityLists(); applyFilters();
};
els.pageSize.onchange=()=>applyFilters();
els.btnCSV.onclick=downloadCSV;

/* старт */
loadData();
</script>
</body>
</html>
