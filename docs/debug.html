<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8">
<title>Диагностика master + inventory</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
  :root{--bg:#0f172a;--fg:#e5e7eb;--muted:#94a3b8;--card:#111827;--ok:#86efac;--bad:#fca5a5;--warn:#facc15}
  body{margin:0;background:var(--bg);color:var(--fg);font:14px/1.45 system-ui,Segoe UI,Roboto,Arial}
  .wrap{max-width:1100px;margin:24px auto;padding:0 16px}
  .card{background:var(--card);border-radius:14px;padding:16px;box-shadow:0 4px 24px rgba(0,0,0,.25);margin-bottom:16px}
  code,pre{font:12px/1.35 ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace}
  .kv{display:grid;grid-template-columns:280px 1fr;gap:8px}
  .kv div:first-child{color:var(--muted)}
  .ok{color:var(--ok)} .bad{color:var(--bad)} .warn{color:var(--warn)}
  .chips{display:flex;gap:6px;flex-wrap:wrap}
  .chip{border:1px solid #223049;background:#0b1322;padding:4px 8px;border-radius:999px}
  .muted{color:var(--muted)}
</style>
</head>
<body>
<div class="wrap">
  <h1>Диагностика master.json + inventory.json</h1>

  <div class="card">
    <div class="kv">
      <div>master.json (товары)</div><div id="mStatus">—</div>
      <div>inventory.json (остатки)</div><div id="iStatus">—</div>
      <div>Товаров (master)</div><div id="mItems">—</div>
      <div>Записей в inventory</div><div id="iItems">—</div>
      <div>Всего offers</div><div id="offers">—</div>
      <div>Уникальных поставщиков</div><div id="supCount">—</div>
      <div>Уникальных городов</div><div id="cityCount">—</div>
      <div>Offers с qty &gt; 0</div><div id="qtyOffers">—</div>
      <div>Покрытие master (товаров с ≥1 offer)</div><div id="coverage">—</div>
      <div>Итог</div><div id="summary">—</div>
    </div>
  </div>

  <div class="card">
    <h3>Коды, которых нет в master (только в inventory) — первые 20</h3>
    <div id="invOnly" class="chips"></div>
  </div>

  <div class="card">
    <h3>Коды из master без предложений — первые 20</h3>
    <div id="masterNoOffers" class="chips"></div>
  </div>

  <div class="card">
    <h3>Пример offer</h3>
    <pre id="firstOffer">—</pre>
  </div>
</div>
<script>
const MASTER_URL='data/master.json', INV_URL='data/inventory.json';
const els = Object.fromEntries(['mStatus','iStatus','mItems','iItems','offers','supCount','cityCount','qtyOffers','coverage','summary','invOnly','masterNoOffers','firstOffer'].map(id=>[id,document.getElementById(id)]));
const S=v=>v==null?'':String(v), N=v=>{const n=Number(v);return Number.isFinite(n)?n:0}, get=(o,...ks)=>{for(const k of ks){if(o&&typeof o==='object'&&o[k]!=null&&S(o[k])!=='')return o[k]}return''}, getNum=(o,...ks)=>N(get(o,...ks));

(async()=>{
  let master=null, invent=null;
  try{ const r=await fetch(MASTER_URL+'?t='+Date.now(),{cache:'no-store'}); els.mStatus.innerHTML=r.ok?'<span class="ok">OK</span>':'<span class="bad">'+r.status+'</span>'; master=await r.json(); }catch(e){ els.mStatus.innerHTML='<span class="bad">ERR</span>'; }
  try{ const r=await fetch(INV_URL+'?t='+Date.now(),{cache:'no-store'}); els.iStatus.innerHTML=r.ok?'<span class="ok">OK</span>':'<span class="bad">'+r.status+'</span>'; invent=await r.json(); }catch(e){ els.iStatus.innerHTML='<span class="bad">ERR</span>'; }

  const mArr = Array.isArray(master)?master:(Array.isArray(master?.items)?master.items:(Array.isArray(master?.data)?master.data:[]));
  const iArr = Array.isArray(invent)?invent:(Array.isArray(invent?.items)?invent.items:invent);
  els.mItems.textContent = mArr.length;
  els.iItems.textContent = Array.isArray(iArr)?iArr.length:Object.keys(iArr||{}).length;

  const invMap=new Map(); let offersTotal=0, offersWithQty=0, first=null;
  if(Array.isArray(iArr)){
    for(const rec of iArr){
      const key=S(get(rec,'code','offer_id','article','id','sku','product_code'));
      let offers=Array.isArray(rec.offers)?rec.offers:(Array.isArray(rec.suppliers)?rec.suppliers:(Array.isArray(rec.proposals)?rec.proposals:(S(get(rec,'supplier','supplier_name','vendor','provider'))?[rec]:[])));
      if(!key) continue; if(!offers) offers=[];
      invMap.set(key,(invMap.get(key)||[]).concat(offers));
      offersTotal += offers.length; if(!first && offers.length) first=offers[0];
    }
  }else if(iArr && typeof iArr==='object'){
    for(const [key,val] of Object.entries(iArr)){ const offers=Array.isArray(val)?val:(Array.isArray(val?.offers)?val.offers:[]); invMap.set(key,offers); offersTotal+=offers.length; if(!first && offers.length) first=offers[0]; }
  }

  const supSet=new Set(), citySet=new Set();
  for(const arr of invMap.values()){
    for(const s of arr){
      const sup=S(get(s,'supplier','supplier_name','vendor','provider'));
      const city=S(get(s,'warehouse_city','city','warehouseCity'));
      const qty=getNum(s,'qty','quantity','stock','rest');
      if(sup) supSet.add(sup);
      if(city) citySet.add(city);
      if(qty>0) offersWithQty++;
    }
  }
  els.offers.textContent=offersTotal;
  els.supCount.textContent=supSet.size;
  els.cityCount.textContent=citySet.size;
  els.qtyOffers.textContent=offersWithQty;

  const masterCodes=new Set(mArr.map(x=>S(get(x,'code','offer_id','article','id','sku','p_code'))).filter(Boolean));
  const invCodes=new Set(invMap.size?Array.from(invMap.keys()):[]);
  const invOnly=[...invCodes].filter(x=>!masterCodes.has(x)).slice(0,20);
  const masterNoOffers=[...masterCodes].filter(x=>!invCodes.has(x)).slice(0,20);

  els.invOnly.innerHTML = invOnly.length?invOnly.map(x=>`<span class="chip">${x}</span>`).join(''):'<span class="muted">—</span>';
  els.masterNoOffers.innerHTML = masterNoOffers.length?masterNoOffers.map(x=>`<span class="chip">${x}</span>`).join(''):'<span class="muted">—</span>';

  const covered = [...masterCodes].filter(x=>invCodes.has(x)).length;
  els.coverage.textContent = `${covered} / ${masterCodes.size} (${masterCodes.size?Math.round(covered/masterCodes.size*100):0}%)`;

  els.summary.innerHTML = (offersTotal>0 && supSet.size>0 && citySet.size>0)
    ? '<span class="ok">OK</span> — inventory даёт предложения/остатки'
    : '<span class="warn">Нужно проверить inventory: нет предложений/поставщиков/городов</span>';

  els.firstOffer.textContent = first?JSON.stringify(first,null,2):'(пусто)';
})();
</script>
</body>
</html>
